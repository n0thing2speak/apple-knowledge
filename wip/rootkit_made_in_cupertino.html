<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Work-in-Progress: Using Apple internal builds for rootkits | Hack Different - Apple Knowledge</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Work-in-Progress: Using Apple internal builds for rootkits" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Hack Different is a community of research around the Apple platform." />
<meta property="og:description" content="Hack Different is a community of research around the Apple platform." />
<link rel="canonical" href="https://docs.hackdiffe.rent/wip/rootkit_made_in_cupertino.html" />
<meta property="og:url" content="https://docs.hackdiffe.rent/wip/rootkit_made_in_cupertino.html" />
<meta property="og:site_name" content="Hack Different - Apple Knowledge" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Work-in-Progress: Using Apple internal builds for rootkits" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Hack Different is a community of research around the Apple platform.","headline":"Work-in-Progress: Using Apple internal builds for rootkits","url":"https://docs.hackdiffe.rent/wip/rootkit_made_in_cupertino.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>Hack Different - Apple Knowledge</h1>
        </a>
        <h2>Hack Different is a community of research around the Apple platform.</h2>

        <section id="downloads">
          
          <a href="https://github.com/hack-different/apple-knowledge" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="work-in-progress-using-apple-internal-builds-for-rootkits">Work-in-Progress: Using Apple internal builds for rootkits</h1>

<h2 id="backstory">Backstory</h2>

<p>Found this years ago while being stalked in SF <a href="https://github.com/rickmark/mojo_thor">mojo_thor</a>.  Recently I’ve found
more kernel extensions beyond just <code class="language-plaintext highlighter-rouge">MojoKDP</code> that are involved.  MojoKDP was originally found by running a VM, then
capturing the memory state providing a core dump. (see other repo)</p>

<p>Also, my ex at Apple is a total criminal for using this over many years to stalk me… But Apple refuses
to discuss the issue with me.</p>

<h2 id="overall-theory">Overall Theory</h2>

<p>Two Possibilities:</p>

<ul>
  <li>Apple signs internal builds for production hardware using production keys allowing anyone
who gains a copy of one to use powerful internal kernel functionality that breaks the
guarantees made in the platform security guide</li>
  <li>Changing a production device to trust DVT/PVT/EVT keys is trivial, then they run internal
builds which have powerful debug capabilities that break the security model.
    <ul>
      <li>Seems this might be related to SMC <code class="language-plaintext highlighter-rouge">MOJO</code> key for switching to non-production builds.</li>
    </ul>
  </li>
</ul>

<h2 id="leveraged-kernel-extensions">Leveraged Kernel Extensions</h2>

<h3 id="comappledriverairportbrcm4360-mfg">com.apple.driver.AirPort.Brcm4360-MFG</h3>

<h3 id="comappledriverairportbrcmnic-mfg">com.apple.driver.AirPort.BrcmNIC-MFG</h3>

<p>Broadcom - perhaps these are the original manufacturer versions?  Implies that there are differs
but not enough data yet.</p>

<h3 id="comappledriverappleastrisgpioprobe">com.apple.driver.AppleAstrisGpioProbe</h3>

<p>Astris is a debug system for iDevices, partially documented elsewhere.  Just assume used to
do evil things to a iDevice restored on the computer.  GPIO implies general purpose IO pins.
This may provide a probed devices PMGR/<code class="language-plaintext highlighter-rouge">force_dfu</code> pins for iDevice restore avoidance or
re-infection.</p>

<h3 id="comappledriverapplebsdkextstartervpn">com.apple.driver.AppleBSDKextStarterVPN</h3>

<p>Based on description, some form of VPN that lives in kernel mode and operates at boot?</p>

<h3 id="comappledriverapplehwaccess">com.apple.driver.AppleHWAccess</h3>

<p>Provides a user mode <code class="language-plaintext highlighter-rouge">AppleHWAccessUserClient</code> IOKit service that allows for direct access to physical memory</p>

<h3 id="comappledriverappleintelcpupowermanagementdriver">com.apple.driver.AppleIntelCPUPowerManagementDriver</h3>

<h3 id="comappledriverapplenvmepassthrough">com.apple.driver.AppleNVMePassThrough</h3>

<p>Provides a IOKit user mode service <code class="language-plaintext highlighter-rouge">AppleNVMePassThroughUC</code> to pass through commands directly to the
NVMe controller.</p>

<p>Dangerous on Apple products as NVMe uses namespaces to store / read things like bridgeOS root filesystem
bridgeOS firmware, SysCfg, NVRAM, etc.  (oh and whatever AppleEAN is?)</p>

<h3 id="comappledriverapplersm">com.apple.driver.AppleRSM</h3>

<h3 id="comappledriverdrizzleplatformsupport">com.apple.driver.DrizzlePlatformSupport</h3>

<p>Some god awful mashup of the SMC, bluetooth and 8254X ethernet…</p>

<p>Wonder if it can be tripped explicitly based on conditions even if intended to be used
via VMware to give a legit use case.</p>

<h3 id="comappledriverdrizzlesmc">com.apple.driver.DrizzleSMC</h3>

<h3 id="comappledriverkernelrelaytesterhost">com.apple.driver.KernelRelayTesterHost</h3>

<p>Seems paired with <code class="language-plaintext highlighter-rouge">com.apple.driver.KernelRelayHost</code>.  Allows for a user mode application to open
the IOKit class <code class="language-plaintext highlighter-rouge">KernelRelayTesterUC</code> to be able to call the following:</p>

<h4 id="exttestfunction">extTestFunction</h4>

<p>Demangled Symbol: <code class="language-plaintext highlighter-rouge">int64_t KernelRelayTesterUC::extTestFunction(KernelRelayTesterUC *__hidden this,
KernelRelayTesterUC *, void *, IOExternalMethodArguments *)</code></p>

<h4 id="extsenddata">extSendData</h4>

<p>Demangled Symbol: <code class="language-plaintext highlighter-rouge">int64_t KernelRelayTesterUC::extSendData(KernelRelayTesterUC *__hidden this,
KernelRelayTesterUC *, void *, IOExternalMethodArguments *)</code></p>

<h4 id="externalmethod">externalMethod</h4>

<p>Demangled Symbol: <code class="language-plaintext highlighter-rouge">int64_t KernelRelayTesterUC::externalMethod(KernelRelayTesterUC *__hidden this,
unsigned int, IOExternalMethodArguments *, IOExternalMethodDispatch *, OSObject *, void *)</code></p>

<h3 id="comappledriverluahardwareaccess">com.apple.driver.LuaHardwareAccess</h3>

<p><a href="https://en.wikipedia.org/wiki/Lua_(programming_language)">Lua</a> is a language often leveraged for lightweight
extension scripts (nginx for example does this).  For reasons beyond me, Apple created a Lua engine for kernel
mode and signed it…</p>

<p>A user mode program can evaluate code in the kernel by using <code class="language-plaintext highlighter-rouge">LuaHardwareAccessUserClient</code> and passing Lua code
to it.</p>

<h3 id="comappledrivermedetect">com.apple.driver.MEDetect</h3>

<p>This appears to be a tool to detect and correct “neuter” Intel management engines.  This process is
acomplised one of two ways, by setting an undocumented “HAP” or high assurance profile bit that
disables the bulk of the ME functionality, crippling the boot code causing the ME to hang, or both.
This should only be applicable for T1 and prior as the MacEFI binary comes from the T2 later on.
The Intel ME is not generally used in the macOS platform, so (warning conjecture) this seems
to be primarily to ensure the device’s ME / AMT / CSME is enabled for SigInt.</p>

<p>It is detection only as only the Intel ME can update its code, therefore it cannot be repaired
barring some non-standard method.  See also <code class="language-plaintext highlighter-rouge">eficheck</code>.</p>

<p>Boot Arguments:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">no_medetect</code></li>
  <li><code class="language-plaintext highlighter-rouge">medetect_panic</code></li>
</ul>

<h3 id="comappledriverkisapplekis">com.apple.driver.kis.AppleKIS</h3>

<p>Second hand knowledge says this is related to the Kanzi internal debug cable.  This would be needed
for demoting a device during restore.  I’m strongly starting to wonder if USB-C cables plumb through
pins that could be used for this purpose, or if it is used with a form of remote USB to tunnel over
other transits.</p>

<h3 id="comappledriverusbappleusbkdp">com.apple.driver.usb.AppleUSBKDP</h3>

<p>USB base kernel debug port.  Combine with below to bad effect.  Only documented kernel debuggers are ethernet,
and legacy Firewire serial.  This seems to allow for USB mode debug.  See also: MojoKDP</p>

<p>Boot Arguments:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">kdp_match_name</code> with values <code class="language-plaintext highlighter-rouge">usb</code>, <code class="language-plaintext highlighter-rouge">XHC</code></li>
  <li><code class="language-plaintext highlighter-rouge">AppleUSBKDP-debug</code></li>
  <li><code class="language-plaintext highlighter-rouge">AppleUSBDebugControllerPCI-debug</code></li>
  <li><code class="language-plaintext highlighter-rouge">AppleUSBXHCIDebugController-debug</code></li>
</ul>

<h3 id="comappleiokitrusbhostfamily">com.apple.iokit.RUSBHostFamily</h3>

<p>Allow for USB devices to appear as though they are local when they are in fact not.  Has a user client
IOKit class, so logical that the device comes from user-mode on the system (which obviously depending
the user mode binary could be from anywhere, synthetic, network, etc)</p>

<p>Boot Arguments:</p>

<ul>
  <li>RUSBHostPort-debug</li>
  <li>RUSBHostController-debug</li>
  <li>RUSBHostDevice-debug</li>
</ul>

<h3 id="comappleiokitfipscavs-kext-tool">com.apple.iokit.fipscavs-kext-tool</h3>

<p>Wanna just break crypto? <a href="https://csrc.nist.gov/CSRC/media/Projects/Cryptographic-Module-Validation-Program/documents/fips140-2/FIPS1402DTR.pdf">https://csrc.nist.gov/CSRC/media/Projects/Cryptographic-Module-Validation-Program/documents/fips140-2/FIPS1402DTR.pdf</a></p>

<p>Seems you can just new up a <code class="language-plaintext highlighter-rouge">IOFIPSCipherUserClient</code></p>

<h3 id="comapplekextmojokdp">com.apple.kext.MojoKDP</h3>

<p>A debug protocol with two versions (mojo1, mojo2).  Original find form 2017 via Parallels memory capture
and the professional edition ability to inject kernel debug.  In this year I had my logic board replaced
multiple times due to graphics issues, each time booting in recovery when the device was new would result
in no entry for <code class="language-plaintext highlighter-rouge">MojoKDP</code> in <code class="language-plaintext highlighter-rouge">ioreg</code> but seemingly after leaving my computer in my apartment alone this
node would appear, but only in recovery mode.</p>

<h3 id="comapplepaedriverapplequaibridgepcie">com.apple.pae.driver.AppleQuaibridgePCIE</h3>

<p>From my best guess seems to be direct access to the PCIe bus?</p>

      </section>
    </div>
  </body>
</html>
